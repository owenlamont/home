
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://owenlamont.github.io/home/blog/archive/2024/">
      
      
        <link rel="prev" href="../../category/virtual-environments/">
      
      
        <link rel="next" href="../2023/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>2024 - Owen's Home</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="2024 - Owen's Home" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://owenlamont.github.io/home/assets/images/social/blog/archive/2024.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://owenlamont.github.io/home/blog/archive/2024/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="2024 - Owen's Home" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://owenlamont.github.io/home/assets/images/social/blog/archive/2024.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2024" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Owen&#39;s Home" class="md-header__button md-logo" aria-label="Owen's Home" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Owen's Home
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2024
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Owen&#39;s Home" class="md-nav__button md-logo" aria-label="Owen's Home" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Owen's Home
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Owen Lamont
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/conda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conda
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/data-visualisation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Visualisation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/geopandas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GeoPandas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/github-actions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitHub Actions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/maritime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maritime
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/matplotlib/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matplotlib
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/movingpandas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MovingPandas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/pytest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pytest
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/python-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/virtual-environments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Virtual Environments
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2024">2024</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-12-29 00:00:00+00:00">December 29, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/github-actions/" class="md-meta__link">GitHub Actions</a>, 
              <a href="../../category/python-package/" class="md-meta__link">Python Package</a>, 
              <a href="../../category/pytest/" class="md-meta__link">Pytest</a></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="testing-a-python-package-on-github"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/">Testing a Python Package on GitHub</a></h2>
<h3 id="testing-a-python-package-on-github_1"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#testing-a-python-package-on-github_1">Testing a Python Package on GitHub</a></h3>
<p>I'm quite new both to building Python packages and also to GitHub actions so here I
describe setting up a workflow to run tests on a Python package across Windows, Ubuntu,
and macOS and across multiple Python versions with combined code coverage using
<a href="https://resources.github.com/learn/pathways/automation/">GitHub actions</a> and
<a href="https://docs.astral.sh/uv/">uv</a>.</p>
<h3 id="tldr"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#tldr">TLDR</a></h3>
<p>I learnt how to setup a cross platform / cross Python version workflow with coverage
while setting up the GitHub repo for my CLI tool
<a href="https://github.com/owenlamont/uv-secure">uv-secure</a>. You can see the final GitHub
action workflow I created for that project in
<a href="https://github.com/owenlamont/uv-secure/blob/main/.github/workflows/pytest.yml">pytest.yml</a>
but beware this workflow depends on some configuration specified in other files of this
repo that I will go into in this post.</p>
<h3 id="my-project-setup"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#my-project-setup">My project setup</a></h3>
<p>I created my package using uv init with the lib option:</p>
<pre><code class="language-shell">uv init --lib
</code></pre>
<p>To create the skeleton package directory structure. The default uv init command is more
intended for creating scripts whereas if you want a Python project that will build and
install as a package then you need the --lib option. You can read more detail in the
<a href="https://docs.astral.sh/uv/reference/cli/#uv-init">uv init docs</a></p>
<p>That creates a repo structure with a</p>
<pre><code class="language-shell">src / package_name
</code></pre>
<p>structure, and I personally like to add a top level tests directory (you need to do this
manually - uv won't create a tests directory for you) and then duplicate the directory
structure for the src directory for my tests structure, e.g.</p>
<pre><code class="language-shell">tests / package_name
</code></pre>
<h3 id="creating-initial-github-workflow"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#creating-initial-github-workflow">Creating initial GitHub workflow</a></h3>
<p>The uv documentation has a specific section for
<a href="https://docs.astral.sh/uv/guides/integration/github">GitHub integration</a>
which I found to be an excellent starting point for setting up a GitHub action. I
started by copying their
<a href="https://docs.astral.sh/uv/guides/integration/github/#syncing-and-running">pytest example</a>
and later tried to incorporate their other example of using
<a href="https://docs.astral.sh/uv/guides/integration/github/#multiple-python-versions">multiple Python versions</a>.</p>
<h4 id="first-gotcha-regarding-python-versions"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#first-gotcha-regarding-python-versions">First gotcha regarding Python versions</a></h4>
<p>I made a few mistakes in my initial attempt to get multiple Python versions working that
were a bit painful to figure out, specifically:</p>
<p>I wanted to target Python 3.9 minimum and every major version after that up to Python
3.13. Given I was targeting 3.9 minimum I had a .python-version file in my repo with the
content:</p>
<pre><code class="language-text">3.9
</code></pre>
<p>which I had checked into source control. I used the
<a href="https://github.com/actions/setup-python">setup-python</a> action as the uv docs mentioned
that can be faster for setting up Python and passed the Python version to that using the
test matrix:</p>
<pre><code class="language-yaml">- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: ${{ matrix.python-version }}
</code></pre>
<p>I saw the setup-python action installing the correct Python, so I assumed it was running
the tests against Python 3.9, 3.10, 3.11, 3.12, and 3.13... but unbeknownst to me uv was
reading the .python-version file in each case and creating a Python 3.9 environment in
each of the VMs even though actions/setup-python had installed the correct Python.</p>
<p><img alt="Python version mismatch" src="../../../img/python_version_mismatch.png" /></p>
<p>I didn't actually notice this issue until a later release when I tried to combine test
coverage reports across my Python versions and noticed they were all giving identical
results so coverage ignored all but one. The solution in this case was to remove the
.python-version file from source control - I still kept a local copy but added it to the
repo .gitignore file. Alternatively don't use the setup-python action and just follow
the uv documentation example where uv installs Python itself.</p>
<p>The more general learning I got was to take the time to inspect the action output more
closely for each step as you can see from the screenshot the problem was easy to spot -
but only if you expand and look at the detailed output for each step.</p>
<h3 id="adding-code-coverage-support"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#adding-code-coverage-support">Adding Code Coverage Support</a></h3>
<p>There's several SaaS services for taking output from
<a href="https://pypi.org/project/coverage/">coverage</a> in Python and tracking test coverage over
time such as <a href="https://about.codecov.io">Codecov</a> or <a href="https://coveralls.io">coveralls</a>
both of which offer free (maybe with limitations) support for open source projects.
However, I wanted to get some basic test coverage reporting that would work without
using those services (yet) so I implemented some simpler action steps to take the
coverage report from coverage and simply add that as a comment to the pull request.</p>
<p>The configuration for those steps looked like this in the end:</p>
<pre><code class="language-yaml">- name: Run coverage report
  run:  uv run coverage report &gt; coverage_summary.txt
- name: Prepare Comment Body
  run: |
    echo '### Coverage Report' &gt;&gt; comment_body.md
    echo '```txt' &gt;&gt; comment_body.md
    cat coverage_summary.txt &gt;&gt; comment_body.md
    echo '' &gt;&gt; comment_body.md
    echo '```' &gt;&gt; comment_body.md
- name: Find Coverage Report Comment
  id: find-comment
  uses: peter-evans/find-comment@v3
  with:
    issue-number: ${{ github.event.pull_request.number }}
    comment-author: github-actions[bot]
    body-includes: '### Coverage Report'
- name: Create or Update Coverage Comment
  uses: peter-evans/create-or-update-comment@v4
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    issue-number: ${{ github.event.pull_request.number }}
    body-path: comment_body.md
    comment-id: ${{ steps.find-comment.outputs.comment-id }}
    edit-mode: replace
</code></pre>
<p>I had some trial and error and issues with the echo calls in the Prepare Comment Body
step as I found I needed to use single tick quotes do get some of the echo calls to
work (they would give really confusing errors with different quotes).</p>
<p>I learnt of <a href="https://github.com/peter-evans">Peter Evan's</a> really handy actions for
creating comments, although it took me a while to identify adding markdown comments
worked best if saved to a file and added via the body-path argument in the
<a href="https://github.com/peter-evans/create-or-update-comment">create-or-update-comment</a>
action. I had many failed attempts trying to use ChatGPT's help to send the comment text
via an environment variable that just caused so many issues.</p>
<p>At first each change to a pull request would create a new coverage comment which got
messy pretty quickly but Peter had a
<a href="https://github.com/peter-evans/create-or-update-comment#where-to-find-the-id-of-a-comment">nice example</a>
of combining his find-comment and create-or-update-comment actions so that you could
create an initial comment for the test coverage and keep overwriting that same comment
after that with new test coverage results as new commits were pushed to the PR.</p>
<p>The last gotcha I ran into with using the create-or-update-comment action was the
default job permissions aren't adequate for jobs to change the pull request itself so
you need to explicitly set the job permissions like this:</p>
<pre><code class="language-yaml">jobs:
  my_job_name:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
</code></pre>
<h3 id="adding-multi-python-version-coverage-report"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#adding-multi-python-version-coverage-report">Adding multi-Python version coverage report</a></h3>
<p>I initially had multiple Python versions running and I just triggered test coverage for
one of the Python versions as a separate step. This was unsatisfactory though as there
was conditional importing happening in my package, e.g. toml parsing was added to the
standard library in later versions of Python but earlier versions required you to
import a separate package, e.g.</p>
<pre><code class="language-python">if sys.version_info &gt;= (3, 11):
    import tomllib as toml
else:
    import tomli as toml
</code></pre>
<p>and it was disappointing running coverage for just one Python version would always omit
one of these import lines. I learnt Coverage.py CLI has a
<a href="https://coverage.readthedocs.io/en/latest/cmd.html#cmd-combine">combine</a> command so you
can run coverage for different environments and combine the results into a single
coverage result.</p>
<p>I had some initial misunderstandings around the combine command as I thought it might
combine one of the output files from running coverage but it actually wants to combine
the .coverage SQLLite db that coverage produces when running. Another gotcha that I ran
into was when running coverage with an intent to combine results the coverage docs
mention using the:</p>
<pre><code class="language-shell">--parallel-mode
</code></pre>
<p>option or configuration to name the .coverage to include extra details to ensure each
.coverage file is named uniquely and I tried to follow that advice. I had an issue
since I was using the <a href="https://pypi.org/project/pytest-cov/">pytest-cov</a> package to
integrate pytest with coverage to run the tests with coverage, and it appears to set
the parallel option for
<a href="https://pytest-cov.readthedocs.io/en/latest/config.html#configuration">its own purposes</a>
so my attempts at setting that configuration never seemed to change the name of the
.coverage output db.</p>
<p>One possible solution would be to get coverage to run pytest without using pytest-cov (
although if you use the coverage feature in recent versions of the VSCode Python
extension that depends on pytest-cov so you may want to keep that dependency even if you
don't use it in CI).</p>
<p>In the end though it wasn't an issue because each test matrix instance runs in its own
VM so you don't need to worry about .coverage files overwriting each other - as long as
you use the upload-artifact action to upload them with different names there's no issue.</p>
<p>In the test run step I used the upload-artifact like so:</p>
<pre><code class="language-yaml">- name: Upload coverage artifact
  uses: actions/upload-artifact@v4
  with:
    name: coverage-${{ matrix.python-version }}
    path: .coverage
    include-hidden-files: true
</code></pre>
<p>and a separate dependant job would collect and combine those individual test artifacts
like so:</p>
<pre><code class="language-yaml">- name: Download all coverage artifacts
  uses: actions/download-artifact@v4
  with:
    path: coverage
- name: Combine coverage data
  run: |
    uv run coverage combine coverage/3.*/.coverage
    uv run coverage report &gt; coverage_summary.txt
</code></pre>
<h3 id="final-step-adding-multiple-platform-coverage-support"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#final-step-adding-multiple-platform-coverage-support">Final step - adding multiple platform coverage support</a></h3>
<p>In the same way I had conditional imports that imported different libraries depending on
the Python version - I also ended up needing conditional imports to handle different
operating system specific dependencies, e.g. for optimised async event loops
<a href="https://pypi.org/project/uvloop/">uvloop</a> is often recommended but that only works on
Linux and macOS (and I hate it when Windows is neglected by Python packages since that
is the OS I work in the most). Once again I need a different conditional import on
Windows instead of uvloop I use <a href="https://pypi.org/project/winloop/">winloop</a> and the
code looks like this:</p>
<pre><code class="language-python">if sys.platform in (&quot;win32&quot;, &quot;cygwin&quot;, &quot;cli&quot;):
    from winloop import run
else:
    from uvloop import run
</code></pre>
<p>If you're interested the project dependencies section of my pyproject.toml for handling
those different import conditions looks like this:</p>
<pre><code class="language-toml">dependencies = [
    'tomli; python_version &lt; &quot;3.11&quot;',
    &quot;uvloop&gt;=0.21.0 ; sys_platform != 'win32'&quot;,
    &quot;winloop&gt;=0.1.7 ; sys_platform == 'win32'&quot;,
]
</code></pre>
<p>so now the next issue is the GitHub matrix must be expanded to cover Linux, macOS, and
Windows and all the major Python versions which now looks like this:</p>
<pre><code class="language-yaml">name: Pytest
on:
  pull_request:
jobs:
  pytest-with-coverage:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [&quot;ubuntu-latest&quot;, &quot;macos-latest&quot;, &quot;windows-latest&quot;]
        python-version: [&quot;3.9&quot;, &quot;3.10&quot;, &quot;3.11&quot;, &quot;3.12&quot;, &quot;3.13&quot;]
</code></pre>
<p>One minor gotcha is don't forget to quote the Python version numbers - I tried unquoted
versions and Python 3.10 was trying to install Python 3.1!</p>
<p>The big gotcha happened though when I tried my old run the combine across my
multi-platform artifacts. The tests and individual coverage ran just fine but the
combine step returned an error status code but no meaningful / actionable error. I spent
a lot of time trying to reproduce the combine problem locally with the CI generated
artifacts and adding extra temporary debug steps into the pipeline before I determined
the issue was each GitHub CI ran the tests in a different relative path in their
respective VMs and coverage didn't recognise these different source paths as being the
same. Specifically the VM specific paths were:</p>
<ul>
<li>ubuntu-latest ran in: /home/runner/work/<repo_name></li>
<li>macos-latest ran in: /Users/runner/work/<repo_name></li>
<li>windows-latest ran in: D:/a/<repo_name></li>
</ul>
<p>I had run into this coverage directory mapping issue before when trying to run coverage
in PyCharm with a Docker environment because of the different (and very non-obvious)
absolute paths it creates for the same project directory.</p>
<p>In short though you need to configure coverage to recognise all these absolute
directories as the same path. Which I did in the pyproject.toml like so:</p>
<pre><code class="language-toml">[tool.coverage.paths]
source = [
  &quot;src&quot;,
  &quot;/Users/runner/work/uv-secure/uv-secure/src&quot;,
  &quot;/home/runner/work/uv-secure/uv-secure/src&quot;,
  &quot;D:/a/uv-secure/uv-secure/src&quot;
]
tests = [
  &quot;tests&quot;,
  &quot;/Users/runner/work/uv-secure/uv-secure/tests&quot;,
  &quot;/home/runner/work/uv-secure/uv-secure/tests&quot;,
  &quot;D:/a/uv-secure/uv-secure/tests&quot;
]
</code></pre>
<p>You can read about other ways to configure these path mappings for coverage in its
<a href="https://coverage.readthedocs.io/en/latest/config.html#paths">path docs</a></p>
<p>Finally after all that trial and error I was able to get a single coverage report
workflow that covered all the major OSes and Python versions I wanted to cover.</p>
<h3 id="related-work-and-summary"><a class="toclink" href="../../2024/12/29/testing-a-python-package-on-github/#related-work-and-summary">Related work and Summary</a></h3>
<p>By chance while developing this I did discover the
<a href="https://github.com/fpgmaas/cookiecutter-uv/">cookiecutter-uv</a> repo which covers a lot
of the same issues (but doesn't as far as I can see deal with combining the code
coverage).</p>
<p>Feel free to look at and re-use the final workflow file in your own repos which is here
<a href="https://github.com/owenlamont/uv-secure/blob/main/.github/workflows/pytest.yml">pytest.yml</a></p>
<p>I leaned on ChatGPT a lot which was good at suggesting the initial workflow
configuration, and it helped a lot with diagnosing the action output (by pasting in the
workflow yaml and the actual action log output) - but ChatGPT definitely lead me into
some dead ends where I needed to research and solve the problem myself (like the proper
way to use the create-or-update-comment action).</p>
<p>I've definitely found developing GitHub actions/workflows a bit painful as I spam push
commits with lots of trial and error until I get them to work right. I haven't tried but
have heard of the <a href="https://github.com/nektos/act">act tool</a> that can apparently let you
test GitHub actions locally before pushing them. I'd be interested to hear how well that
has worked for other developers and what limitations it might have.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!-- Social links -->
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/owenlamont" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/channel/UCYoZjpdGVH2X1MBgRD71lHw" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@owenrlamont" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.5 102.5 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5m-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/owen-lamont/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>